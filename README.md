# 22.01.2026-202

Это методическое руководство разработано специально для студентов с начальным уровнем подготовки. Оно содержит пошаговые инструкции, объяснения «на пальцах» и полные листинги кода, которые можно копировать и вставлять.

---

### МЕТОДИЧЕСКОЕ РУКОВОДСТВО К СЕМИНАРУ
**Дисциплина:** МДК.09.03 Обеспечение безопасности веб-приложений
**Тема:** Разделение прав доступа (RBAC) и защита административной панели
**Дата:** 22 января 2026 г.
**Время:** 15:05 – 16:35

---

#### ВВЕДЕНИЕ: ЗАЧЕМ МЫ ЭТО ДЕЛАЕМ?
Представьте ночной клуб.
1.  **Аутентификация (Вход):** Охранник проверяет паспорт. Если вам есть 18, вы проходите. Это мы сделали на прошлом занятии (Login).
2.  **Авторизация (Роли):** В клубе есть общий зал (для всех) и VIP-зона (только для особых гостей).
    *   Если у вас браслет «Гость» (`client`) — в VIP вас не пустят.
    *   Если у вас браслет «Админ» (`admin`) — вы можете зайти везде.

**Наша цель сегодня:** Выдать пользователям «виртуальные браслеты» (роли) и поставить «вышибалу» (скрипт-проверку) на входе в панель администратора.

---

#### ШАГ 1. АНАЛИЗ ВАШЕЙ ТЕМЫ (5 минут)
Посмотрите на тему своей курсовой работы. Вам нужно понять, кто у вас «Админ», а кто «Клиент».

*   **Если у вас Магазин:** Админ — Товаровед (добавляет товары), Клиент — Покупатель.
*   **Если у вас Библиотека:** Админ — Библиотекарь, Клиент — Читатель.
*   **Если у вас HelpDesk:** Админ — Техподдержка, Клиент — Заявитель.

*В базе данных (таблица `users`, поле `role`) мы будем использовать технические названия: `'admin'` и `'client'`.*

---

#### ШАГ 2. МОДИФИКАЦИЯ ВХОДА (Задача A)
**Цель:** Когда пользователь входит на сайт, сервер должен запомнить не только его ID, но и его РОЛЬ.

1.  Откройте файл **`login.php`** (который вы делали вчера).
2.  Найдите блок, где проверяется пароль (`password_verify`).
3.  Добавьте одну строчку кода для сохранения роли в сессию.

**Как должен выглядеть код (Полный пример):**

```php
<?php
session_start();
require 'db.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email = $_POST['email'];
    $pass = $_POST['password'];

    // Ищем пользователя по email
    $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch();

    // Проверяем пароль
    if ($user && password_verify($pass, $user['password_hash'])) {
        
        // --- НАЧАЛО ИЗМЕНЕНИЙ ---
        // Запоминаем данные пользователя в сессию
        $_SESSION['user_id'] = $user['id'];
        
        // ВАЖНО: Сохраняем роль! Это наш "браслет"
        $_SESSION['user_role'] = $user['role']; 
        // --- КОНЕЦ ИЗМЕНЕНИЙ ---

        // Перенаправляем: Админа в админку, Клиента в профиль
        if ($user['role'] === 'admin') {
            header("Location: admin_panel.php");
        } else {
            header("Location: index.php"); // Или profile.php
        }
        exit;
    } else {
        echo "Неверный логин или пароль";
    }
}
?>
<!-- Далее идет HTML форма... -->
```

---

#### ШАГ 3. СОЗДАНИЕ «ВЫШИБАЛЫ» (Задача B)
**Цель:** Создать отдельный файл-проверку. Мы будем подключать его на любой странице, которую хотим защитить от простых смертных.

1.  Создайте в VS Code новый файл **`check_admin.php`**.
2.  Вставьте в него этот код целиком:

```php
<?php
// check_admin.php — Скрипт защиты (Middleware)

// 1. Включаем доступ к сессии
session_start();

// 2. Проверяем два условия:
//    А. Пользователь вообще вошел? (есть ли user_id)
//    Б. Его роль — это 'admin'?
if (!isset($_SESSION['user_id']) || $_SESSION['user_role'] !== 'admin') {
    
    // Если условия не выполнены — останавливаем работу жестко
    // Можно сделать красивее (редирект), но для безопасности надежнее так:
    die("ДОСТУП ЗАПРЕЩЕН. У вас нет прав администратора. <a href='login.php'>Войти</a>");
}

// Если код идет дальше — значит, это Админ.
?>
```

3.  Сохраните файл и загрузите на сервер (Beget).

---

#### ШАГ 4. СОЗДАНИЕ ПАНЕЛИ АДМИНИСТРАТОРА
**Цель:** Создать страницу, куда может попасть только Админ.

1.  Создайте файл **`admin_panel.php`**.
2.  Вставьте код:

```php
<?php
// Самая первая строчка — вызов охраны!
require 'check_admin.php'; 
?>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админка</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-5">
    <div class="container">
        <div class="alert alert-success">
            <h1>Панель Администратора</h1>
            <p>Добро пожаловать, Повелитель!</p>
            <p>Здесь вы будете управлять: <?php echo "Ваша тема курсовой"; ?></p>
        </div>
        
        <a href="logout.php" class="btn btn-danger">Выйти</a>
    </div>
</body>
</html>
```

**Как проверить:**
1.  Попробуйте открыть `admin_panel.php` **без входа**. Вы должны увидеть сообщение "ДОСТУП ЗАПРЕЩЕН".
2.  Войдите под пользователем с ролью `client`. Вы тоже должны увидеть "ДОСТУП ЗАПРЕЩЕН".
3.  Войдите под пользователем с ролью `admin` (которого мы создали вчера через SQL). Вы должны увидеть зеленую панель.

---

#### ШАГ 5. ЗАЩИТА РЕГИСТРАЦИИ (Задача C)
**Угроза:** Хакер может попытаться подделать запрос и отправить серверу параметр `role=admin` при регистрации, чтобы сразу стать главным. Это называется **Mass Assignment** (Массовое присвоение) или **Privilege Escalation** (Повышение привилегий).

**Решение:** Мы должны **жестко** прописать в коде, что любой, кто регистрируется через сайт — это `client`.

1.  Откройте файл **`register.php`**.
2.  Найдите место, где формируется SQL-запрос `INSERT`.
3.  Убедитесь, что вы **НЕ** берете роль из `$_POST`.

**Правильный (Безопасный) код:**

```php
// ... (валидация выше) ...

// Генерируем хеш пароля
$hash = password_hash($pass, PASSWORD_DEFAULT);

// ВНИМАНИЕ НА ЭТУ СТРОКУ:
// Мы пишем 'client' прямо в SQL запросе (или в параметрах).
// Мы НЕ пишем $_POST['role'] — это была бы дыра в безопасности!

$sql = "INSERT INTO users (email, password_hash, role) VALUES (:email, :hash, 'client')";

$stmt = $pdo->prepare($sql);
$stmt->execute([
    ':email' => $email,
    ':hash' => $hash
]);

// ... (далее успех) ...
```

**Задание:** Проверьте свой код `register.php`. Если вы видите там что-то вроде `$role = $_POST['role']` — **немедленно удалите это**. Роль при регистрации всегда должна быть фиксированной (`'client'`).

---

#### ИТОГОВЫЙ ЧЕК-ЛИСТ (Сдать преподавателю)
1.  [ ] При входе в `login.php` роль сохраняется в сессию.
2.  [ ] Файл `check_admin.php` создан и работает.
3.  [ ] Страница `admin_panel.php` не открывается без авторизации под админом.
4.  [ ] В `register.php` роль `'client'` прописана жестко в коде.
